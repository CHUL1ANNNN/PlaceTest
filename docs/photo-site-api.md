# Спецификация интеграции с сайтом обработки фото (Task 1)

Документ описывает минимальный контракт между приложением и сайтом обработки фото,
чтобы приложение всегда могло получить готовые обработанные фото по ID партии/машины.

## Авторизация

Все запросы к API требуют токен доступа.

- Заголовок: `Authorization: Bearer <TOKEN>`
- Токен выдаётся администратором сайта обработки фото.
- При отсутствии или истечении токена API возвращает `401 Unauthorized`.

## Базовый URL

```
https://photo-site.example.com/api/v1
```

## Сущности

- **Batch (партия)** — набор обработанных фото для одной машины.
- `batch_id` — уникальный идентификатор партии.
- `machine_id` — идентификатор машины (может повторяться в разных партиях).

## 1) Получить список батчей (опционально)

Используется для обзора последних партий и их статусов.

### Запрос

```
GET /batches?status=ready&limit=20&offset=0
Authorization: Bearer <TOKEN>
```

Параметры (все опциональны):
- `status`: `processing | ready | failed`.
- `limit`: количество записей (по умолчанию 20).
- `offset`: смещение (по умолчанию 0).

### Ответ

```
200 OK
Content-Type: application/json

{
  "items": [
    {
      "batch_id": "b_2024_10_15_001",
      "machine_id": "car_9345",
      "status": "ready",
      "photos_count": 24,
      "updated_at": "2024-10-15T12:30:00Z"
    }
  ],
  "total": 128
}
```

## 2) Получить батч по batch_id

Основной метод для получения готовых фото.

### Запрос

```
GET /batches/{batch_id}
Authorization: Bearer <TOKEN>
```

### Ответ

```
200 OK
Content-Type: application/json

{
  "batch_id": "b_2024_10_15_001",
  "machine_id": "car_9345",
  "status": "ready",
  "ready_at": "2024-10-15T12:29:00Z",
  "photos": [
    {
      "photo_id": "p_001",
      "type": "exterior_front",
      "index": 1,
      "url": "https://photo-site.example.com/storage/b_2024_10_15_001/01_exterior_front.jpg"
    },
    {
      "photo_id": "p_002",
      "type": "exterior_back",
      "index": 2,
      "url": "https://photo-site.example.com/storage/b_2024_10_15_001/02_exterior_back.jpg"
    }
  ]
}
```

## Формат ссылок на фото

- `url` — абсолютная ссылка на файл.
- Файлы доступны по HTTPS без дополнительной авторизации (публичная ссылка).
- Формат: `https://photo-site.example.com/storage/{batch_id}/{index}_{type}.jpg`

## Порядок фото

Порядок задаётся полем `index` в массиве `photos`.

Правила:
1. Сортировка всегда выполняется по `index` (возрастание).
2. Нумерация начинается с `1` и без пропусков.
3. Если `index` отсутствует или дублируется, батч считается некорректным и не готовым.
4. `type` — человекочитаемая категория (например, `exterior_front`, `interior_dashboard`).

## Что считается «готово»

Батч готов, если выполняются все условия:
- `status` равен `ready`.
- `photos_count` совпадает с количеством элементов в `photos`.
- Все элементы `photos` имеют `url` и уникальный `index` без пропусков.
- `ready_at` заполнен (ISO 8601).

Если хотя бы одно условие не выполнено, приложение должно считать батч неготовым и повторить попытку позже.
